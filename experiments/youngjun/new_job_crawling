import mysql.connector
import requests
import xml.etree.ElementTree as ET
import json
import re
import schedule
import time
from dotenv import load_dotenv
import os

# ğŸ” í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# ==========================
#  ğŸ”‘ Worknet API KEY ì§ì ‘ ì…ë ¥
# ==========================
WORKNET_API_KEY = "d021e94c-74ff-4fcf-8ed5-576898fdd9a2"

# ==========================
#  ë¬¸ìì—´ ì •ê·œí™” (ê¸°ì—…ëª… ë¹„êµìš©)
# ==========================
def _normalize(s: str) -> str:
    """ê¸°ì—…ëª…/ë³„ì¹­ì„ ë‹¨ìˆœí™”í•˜ì—¬ ë¹„êµ ê°€ëŠ¥í•˜ê²Œ ì •ê·œí™”"""
    if not s:
        return ""
    s = re.sub(r"\(ì£¼\)", "", s)      
    s = re.sub(r"[\sÂ·â€¢\-_/]", "", s)  
    s = re.sub(r"[^\wê°€-í£]", "", s)    
    return s.lower()

# ==========================
#  ê´€ì‹¬ ê¸°ì—… ì„¸íŠ¸ êµ¬ì¶•
# ==========================
def build_interest_set(companies, aliases):
    """DBì—ì„œ ê°€ì ¸ì˜¨ ê¸°ì—…ëª… + ë³„ì¹­ì„ ì •ê·œí™”í•˜ì—¬ Setìœ¼ë¡œ ë§Œë“¦"""
    norm_set = set()
    for c in companies:
        norm_set.add(_normalize(c))
    for a in aliases:
        if a:
            norm_set.add(_normalize(a))
    return norm_set

# ==========================
#  ê´€ì‹¬ ê¸°ì—… ë§¤ì¹­ í•¨ìˆ˜
# ==========================
def is_interest_company(company_name: str, interest_norm_set) -> bool:
    """ì±„ìš©ê³µê³  ê¸°ì—…ëª…ì´ ê´€ì‹¬ê¸°ì—… ë¦¬ìŠ¤íŠ¸ì— í•´ë‹¹í•˜ëŠ”ì§€ ê²€ì‚¬"""
    n = _normalize(company_name)
    if not n:
        return False
    if n in interest_norm_set:
        return True
    for target in interest_norm_set:
        if target in n or n in target:
            return True
    return False

# ==========================
#  DB ì„¤ì • (ì‚¬ìš©ìê°€ ì œê³µí•œ ì •ë³´ë¡œ ì§ì ‘ ì„¤ì •)
# ==========================
db_config = {
    'host': 'localhost',
    'user': 'root', 
    'password': 'dldudwns01~', 
    'database': 'mysql'
}

# ==========================
#  DBì—ì„œ ê´€ì‹¬ ê¸°ì—… ë¶ˆëŸ¬ì˜¤ê¸°
# ==========================
def fetch_companies_from_db():
    print("\nğŸ” DBì—ì„œ ê´€ì‹¬ ê¸°ì—… ë¶ˆëŸ¬ì˜¤ê¸°")
    companies, aliases = [], []
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        cursor.execute("SELECT name, alias FROM companies")
        rows = cursor.fetchall()
        companies = [row[0] for row in rows if row[0]]
        aliases = [row[1] for row in rows if len(row) > 1 and row[1]]
        print(f"âœ… DB ê¸°ì—…ëª… {len(companies)}ê°œ, ë³„ì¹­ {len([a for a in aliases if a])}ê°œ ë¶ˆëŸ¬ì˜´")
    except mysql.connector.Error as err:
        print(f"âŒ DB ì˜¤ë¥˜: {err}")
    finally:
        if 'conn' in locals() and conn.is_connected():
            cursor.close()
            conn.close()
    return companies, aliases

# ==========================
#  API í˜¸ì¶œ ë° ê´€ì‹¬ê¸°ì—… í•„í„°ë§
# ==========================
def fetch_and_filter_jobs(companies, aliases):
    if not companies:
        print("âŒ ê´€ì‹¬ ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.")
        return []

    url = "https://www.work24.go.kr/cm/openApi/call/wk/callOpenApiSvcInfo210L21.do" 
    all_raw_jobs = []
    interest_norm_set = build_interest_set(companies, aliases)

    print("\nğŸ“¦ 'ì±„ìš©ì •ë³´' API ìˆ˜ì§‘ ì‹œì‘\n")

    for page in range(1, 4):
        params = {
            "authKey": WORKNET_API_KEY,  
            "callTp": "L",
            "returnType": "XML",
            "startPage": str(page),
            "display": "100"
        }

        try:
            response = requests.get(url, params=params)
            response.raise_for_status()

            root = ET.fromstring(response.content)

            for job_item in root.findall(".//dhsOpenEmpInfo"):
                company_name = job_item.findtext("empBusiNm") or ""

                if not is_interest_company(company_name, interest_norm_set):
                    continue
                
                print(f"ğŸ¯ ë§¤ì¹­ëœ ê¸°ì—…: {company_name}")

                job_data = {
                    "company_name": company_name,
                    "job_title": job_item.findtext("empWantedTitle"),
                    "employment_type": job_item.findtext("empWantedTypeNm"),
                    "start_date": job_item.findtext("empWantedStdt"),
                    "end_date": job_item.findtext("empWantedEndt"),
                    "company_type": job_item.findtext("coClcdNm"),
                    "company_logo": job_item.findtext("regLogImgNm"),
                    "apply_link": job_item.findtext("empWantedHomepgDetail"),
                    "job_id": job_item.findtext("wantedAuthNo") 
                }
                all_raw_jobs.append(job_data)

        except Exception as e:
            print(f"âŒ API ì˜¤ë¥˜ (í˜ì´ì§€ {page}): {e}")
            continue

    print(f"\nğŸ“Š ê´€ì‹¬ê¸°ì—… ê³µê³  ìˆ˜ì§‘ ê²°ê³¼: {len(all_raw_jobs)}ê±´")
    return all_raw_jobs

# ==========================
#  ê¸°ì¡´ DBì—ì„œ job_id ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì¤‘ë³µ ë°©ì§€ìš©)
# ==========================
def fetch_existing_job_ids_from_db():
    """DBì—ì„œ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” job_id ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    existing_job_ids = set()
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        cursor.execute("SELECT job_id FROM jobs")
        rows = cursor.fetchall()
        existing_job_ids = {row[0] for row in rows}
    except mysql.connector.Error as err:
        print(f"âŒ DB ì˜¤ë¥˜: {err}")
    finally:
        if 'conn' in locals() and conn.is_connected():
            cursor.close()
            conn.close()
    return existing_job_ids

# ==========================
#  DBì— ê³µê³  ì €ì¥ (ì—…ë°ì´íŠ¸ ë° ì‚½ì…, ì¤‘ë³µ ì²˜ë¦¬)
# ==========================
def upsert_jobs_to_db(data):
    if not data:
        print("ğŸ’¡ ìˆ˜ì§‘ëœ ê³µê³ ê°€ ì—†ì–´ DBì— ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    existing_job_ids = fetch_existing_job_ids_from_db()  # ê¸°ì¡´ job_id ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

    # ì¤‘ë³µë˜ì§€ ì•Šì€ ìƒˆë¡œìš´ ê³µê³ ë§Œ DBì— ì¶”ê°€í•©ë‹ˆë‹¤.
    new_jobs = [job for job in data if job['job_id'] not in existing_job_ids]

    if not new_jobs:
        print("ğŸ’¡ ìƒˆë¡œìš´ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¡´ ê³µê³ ë§Œ ê°±ì‹ ë©ë‹ˆë‹¤.")
        return

    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()

        job_tuples = [
            (
                job.get('company_name'),
                job.get('job_title'),
                job.get('employment_type'),
                job.get('start_date'),
                job.get('end_date'),
                job.get('company_type'),
                job.get('company_logo'),
                job.get('apply_link'),
                job.get('job_id')
            ) for job in new_jobs
        ]

        # âœ… INSERT ì¿¼ë¦¬ì— job_id ì—´ ì¶”ê°€, ON DUPLICATE KEY UPDATEë¡œ ê¸°ì¡´ ë°ì´í„° ê°±ì‹ 
        query = """
            INSERT INTO jobs (
                company_name, job_title, employment_type, start_date,
                end_date, company_type, company_logo, apply_link, job_id
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
            ON DUPLICATE KEY UPDATE
                company_name=VALUES(company_name),
                job_title=VALUES(job_title),
                employment_type=VALUES(employment_type),
                start_date=VALUES(start_date),
                end_date=VALUES(end_date),
                company_type=VALUES(company_type),
                company_logo=VALUES(company_logo),
                apply_link=VALUES(apply_link);
        """

        cursor.executemany(query, job_tuples)
        conn.commit()

        print(f"âœ… ì´ {cursor.rowcount}ê°œ ê³µê³ ê°€ DBì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹ ê·œ + ê°±ì‹ ).")

        # ì‹ ê·œ ê³µê³ ì™€ ê°±ì‹ ëœ ê³µê³  ì¶œë ¥
        print("\nğŸ‰ ì¶”ê°€ëœ ì‹ ê·œ ê³µê³ :")
        for job in new_jobs:
            print(f"- {job['company_name']} - {job['job_title']} (ID: {job['job_id']})")

    except mysql.connector.Error as err:
        print(f"âŒ DB ì €ì¥ ì˜¤ë¥˜: {err}")
    finally:
        if 'conn' in locals() and conn.is_connected():
            cursor.close()
            conn.close()

def create_jobs_table():
    conn = None
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        
        create_table_query = """
            CREATE TABLE IF NOT EXISTS jobs (
                id INT AUTO_INCREMENT PRIMARY KEY,
                company_name VARCHAR(255),
                job_title VARCHAR(255),
                employment_type VARCHAR(255),
                start_date VARCHAR(255),
                end_date VARCHAR(255),
                company_type VARCHAR(255),
                company_logo VARCHAR(255),
                apply_link VARCHAR(255),
                job_id VARCHAR(255) UNIQUE, 
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        """
        cursor.execute(create_table_query)
        print("âœ… 'jobs' í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
    except mysql.connector.Error as err:
        print(f"âŒ í…Œì´ë¸” ìƒì„± ì˜¤ë¥˜: {err}")
    finally:
        if conn and conn.is_connected():
            cursor.close()
            conn.close()

# ==========================
#  ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì • (10ì‹œ, 14ì‹œ, 19ì‹œì— API í˜¸ì¶œ)
# ==========================
def job():
    print("âœ… 10:00, 14:00, 19:00, API í˜¸ì¶œ ì‹œì‘...")

    companies, aliases = fetch_companies_from_db()
    raw_jobs = fetch_and_filter_jobs(companies, aliases)
    
    if raw_jobs:
        upsert_jobs_to_db(raw_jobs)
    else:
        print("ğŸ’¡ ìˆ˜ì§‘ëœ ìƒˆë¡œìš´ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
# 10ì‹œ, 14ì‹œ, 19ì‹œë§ˆë‹¤ API í˜¸ì¶œ
schedule.every().day.at("10:00").do(job)
schedule.every().day.at("14:00").do(job)
schedule.every().day.at("19:00").do(job)

# ==========================
#  ë©”ì¸ ì‹¤í–‰
# ==========================
def main():
    print("\n=== ğŸ“ˆ Job Crawling ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹œì‘ ===")
    create_jobs_table()

    # 1. ì²« ë²ˆì§¸ ì‹¤í–‰ ì‹œ API í˜¸ì¶œ (ìˆ˜ë™ ì‹¤í–‰)
    companies, aliases = fetch_companies_from_db()
    raw_jobs = fetch_and_filter_jobs(companies, aliases)

    if raw_jobs:
        upsert_jobs_to_db(raw_jobs)  # ì²« ì‹¤í–‰ì—ì„œ ë°”ë¡œ í˜¸ì¶œí•˜ì—¬ DB ì—…ë°ì´íŠ¸
        print("\nğŸ‰ ì±„ìš©ê³µê³  ìˆ˜ì§‘ ì™„ë£Œ")
    else:
        print("\nğŸ’¡ ê´€ì‹¬ ê¸°ì—… ê³µê³  ì—†ìŒ")

    print("\n=== ğŸ Job Crawling ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘ ===")
    
    # 2. ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ê³„ì† ëŒì•„ê°€ë„ë¡
    while True:
        schedule.run_pending()  # ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì‹¤í–‰ë  ë•Œ ëŒ€ê¸°
        time.sleep(1)

if __name__ == "__main__":
    main()
