import mysql.connector
import json
from datetime import datetime
from dotenv import load_dotenv
import os

# ğŸ” í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# ==========================
# DB ì„¤ì • (ì‚¬ìš©ì ì œê³µ ì •ë³´ ê·¸ëŒ€ë¡œ)
# ==========================
db_config = {
    'host': 'localhost',
    'user': 'root',
    'password': 'dldudwns01~',
    'database': 'mysql'
}

# ==========================
# ê´€ì‹¬ ê¸°ì—… ë¦¬ìŠ¤íŠ¸ SQLì—ì„œ ê°€ì ¸ì˜¤ê¸°
# ==========================
def fetch_interest_companies():
    interest_companies = []
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT name, alias FROM companies")
        rows = cursor.fetchall()
        for row in rows:
            names = [row['name']]
            if row['alias']:
                # ì‰¼í‘œ ê¸°ì¤€ìœ¼ë¡œ ë³„ì¹­ ë¶„ë¦¬ í›„ strip
                aliases = [a.strip() for a in row['alias'].split(',')]
                names.extend(aliases)
            interest_companies.append({
                "main_name": row['name'],
                "aliases": names
            })
    except mysql.connector.Error as err:
        print(f"âŒ DB ì˜¤ë¥˜ (ê´€ì‹¬ ê¸°ì—… ì¡°íšŒ): {err}")
    finally:
        if 'conn' in locals() and conn.is_connected():
            cursor.close()
            conn.close()
    return interest_companies

# ==========================
# ê´€ì‹¬ ê¸°ì—… ê³µê³  í•„í„°ë§
# ==========================
def fetch_interest_jobs():
    jobs = []
    interest_companies = fetch_interest_companies()
    if not interest_companies:
        print("ğŸ’¡ ê´€ì‹¬ ê¸°ì—… ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
        return jobs

    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT * FROM jobs")
        all_jobs = cursor.fetchall()

        for job in all_jobs:
            job_company = job.get('company_name')
            if not job_company:
                continue
            for company in interest_companies:
                if job_company in company['aliases']:
                    jobs.append(job)
                    break  # ì¤‘ë³µ ë°©ì§€

    except mysql.connector.Error as err:
        print(f"âŒ DB ì˜¤ë¥˜ (ê³µê³  ì¡°íšŒ): {err}")
    finally:
        if 'conn' in locals() and conn.is_connected():
            cursor.close()
            conn.close()
    return jobs

# ==========================
# JSON íŒŒì¼ ì €ì¥
# ==========================
def save_jobs_to_json(jobs, filename="interest_jobs.json"):
    if not jobs:
        print("ğŸ’¡ ì €ì¥í•  ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    # datetime ì§ë ¬í™” ì²˜ë¦¬
    def json_serializer(obj):
        if isinstance(obj, datetime):
            return obj.isoformat()
        return str(obj)

    try:
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(jobs, f, ensure_ascii=False, indent=4, default=json_serializer)
        print(f"âœ… ê´€ì‹¬ ê¸°ì—… ê³µê³  JSON ì €ì¥ ì™„ë£Œ: {len(jobs)}ê±´ â†’ {filename}")
    except Exception as e:
        print(f"âŒ JSON ì €ì¥ ì˜¤ë¥˜: {e}")

# ==========================
# ë©”ì¸ ì‹¤í–‰
# ==========================
def main():
    jobs = fetch_interest_jobs()
    save_jobs_to_json(jobs)

if __name__ == "__main__":
    main()
